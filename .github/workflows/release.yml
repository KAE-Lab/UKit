name: Mobile App Release

on:
  push:
    tags:
      - 'v*'

  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Sauter le build EAS (rÃ©cupÃ©rer le dernier APK fini) ?'
        type: boolean
        default: false
      target_tag:
        description: 'Tag Ã  utiliser pour la release (ex: v5.1.0)'
        type: string
        required: true
        default: ''

permissions:
  contents: write

jobs:
  build:
    name: Build and Release APK
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ— Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ðŸ— Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ðŸ“¦ Install dependencies
        run: npm install

      - name: ðŸš€ Build APK on EAS (Cloud)
        id: build_eas
        # On lance le build sans --output car c'est un build Cloud
        if: github.event.inputs.skip_build != 'true'
        run: eas build --platform android --profile preview --non-interactive --wait

      - name: ðŸ“¥ Download APK from Expo
        run: |
          # On rÃ©cupÃ¨re l'URL du dernier build fini pour le profil preview
          URL=$(eas build:list --platform android --profile preview --status finished --limit 1 --json --non-interactive | jq -r '.[0].artifacts.buildUrl')
          echo "TÃ©lÃ©chargement de l'APK depuis : $URL"
          curl -L "$URL" -o ukit-release.apk
    
      - name: Determine Release Tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "RELEASE_TAG=${{ github.event.inputs.target_tag }}" >> $GITHUB_ENV
          else
            echo "RELEASE_TAG=${{ github.ref_name }}" >> $GITHUB_ENV
          fi

      - name: ðŸ“¥ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./ukit-release.apk
          tag_name: ${{ env.RELEASE_TAG }}
          name: Release ${{ env.RELEASE_TAG }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
