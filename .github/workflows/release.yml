name: Mobile App Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build and Release APK
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ— Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: ğŸ— Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm install

      - name: ğŸš€ Build APK on EAS (Cloud)
        id: build_eas
        # On lance le build sans --output car c'est un build Cloud
        run: eas build --platform android --profile preview --non-interactive --wait

      - name: ğŸ“¥ Download APK from Expo
        run: |
          # On rÃ©cupÃ¨re l'URL du dernier build fini pour le profil preview
          URL=$(eas build:list --platform android --profile preview --status finished --limit 1 --json --non-interactive | jq -r '.[0].artifacts.buildUrl')
          echo "TÃ©lÃ©chargement de l'APK depuis : $URL"
          curl -L "$URL" -o ukit-release.apk

      - name: ğŸ“¥ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./ukit-release.apk
          name: Release ${{ github.ref_name }}
          body: |
            ## Nouvelle version ${{ github.ref_name }}
            Compilation automatique effectuÃ©e via EAS Build (Cloud).
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
